name: CI Validate & Test

on:
  pull_request:
    branches:
      - beta
      - dev
  push:
    branches:
      - main
      - beta
      - dev

permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  validate:
    name: Validate & Test
    runs-on: ubuntu-latest

    env:
      PIP_CACHE_DIR: ~/.cache/pip
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      S3_PREFIX: ${{ github.ref_name }}
      S3_BUCKET: ${{ secrets.RESUME_BUCKET }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # --- Clean up stale Terraform locks (if any) ---
      - name: Install AWS SDK for Python
        run: pip install boto3

      - name: Cleanup stale Terraform DynamoDB locks
        run: |
          python terraform/scripts/tf_unlock_stale.py \
            --table dyning_table \
            --age 30 \
            --region ${{ env.AWS_REGION }} \
            --auto-unlock || echo "No stale locks found or cleanup failed, proceeding..."
        continue-on-error: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.9.0'

      - name: Install terraform-docs (optional)
        run: |
          wget -q https://github.com/terraform-docs/terraform-docs/releases/download/v0.17.0/terraform-docs-v0.17.0-linux-amd64.tar.gz
          tar -xzf terraform-docs-v0.17.0-linux-amd64.tar.gz
          sudo mv terraform-docs /usr/local/bin/
          terraform-docs --version

      - name: Install tflint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
          tflint --version || echo "tflint install failed"

      # Python lint / formatting / code quality
      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit black flake8 flake8-bugbear boto3 requests
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Python code lint & format (non-blocking)
        continue-on-error: true
        run: |
          black --check .
          flake8 --max-line-length 88 --extend-ignore=E203,E501,W503 \
            --exclude=.git,__pycache__,venv,.venv,build,dist \
            --per-file-ignores="__init__.py:F401" .

      # Terraform formatting & static checks + validate
      - name: Terraform fmt + validate
        working-directory: ./terraform
        run: |
          terraform fmt -recursive
          terraform fmt -check -recursive
          terraform init -reconfigure -lock=false
          terraform validate
      
      - name: Terraform docs generation (optional)
        working-directory: ./terraform
        run: |
          terraform-docs markdown table --output-file README.md --output-mode inject .  
    
      - name: Install AWS SDK for Python
        run: pip install boto3

      - name: Cleanup stale Terraform DynamoDB locks
        run: |
          python terraform/scripts/tf_unlock_stale.py \
            --table dyning_table \
            --age 30 \
            --region ${{ env.AWS_REGION }} \
            --auto-unlock || echo "No stale locks found or cleanup failed, proceeding..."
        continue-on-error: true