name: CI Validate & Test

on:
  pull_request:
    branches:
      - beta
      - dev
  push:
    branches:
      - beta
      - dev

permissions:
  contents: read            # checkout only needs read
  id-token: write
  pull-requests: write

jobs:
  validate:
    name: Validate & Test
    runs-on: ubuntu-latest

    env:
      PIP_CACHE_DIR: ~/.cache/pip
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.9.0'

      - name: Install terraform-docs (for docs / formatting check, optional)
        run: |
          wget -q https://github.com/terraform-docs/terraform-docs/releases/download/v0.17.0/terraform-docs-v0.17.0-linux-amd64.tar.gz
          tar -xzf terraform-docs-v0.17.0-linux-amd64.tar.gz
          sudo mv terraform-docs /usr/local/bin/
          terraform-docs --version

      - name: Install tflint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
          tflint --version || echo "tflint install failed"

      # Python lint / formatting / code quality
      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit black flake8 flake8-bugbear boto3 requests
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Python code lint & format
        run: |
          black --check .
          flake8 --max-line-length 88 --extend-ignore=E203,E501,W503 \
            --exclude=.git,__pycache__,venv,.venv,build,dist \
            --per-file-ignores="__init__.py:F401" .

      # Terraform formatting & static checks
      - name: Terraform fmt-check + validate
        working-directory: ./terraform
        run: |
          terraform fmt -check -recursive
          terraform init -backend=false   # skip backend init for pure validation
          terraform validate

      # Terraform plan (only on PR or main push)
      - name: Terraform plan
        if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
        working-directory: ./terraform
        run: |
          terraform init
          terraform plan -no-color -out=tfplan
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ env.AWS_REGION }}

      # Upload plan artifact (for review / future apply)
      - name: Upload Terraform plan
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.sha }}
          path: terraform/tfplan
          retention-days: 7

      # Terraform apply (only on push to main)
      - name: Terraform apply
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        working-directory: ./terraform
        run: |
          terraform apply -auto-approve tfplan
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ env.AWS_REGION }}