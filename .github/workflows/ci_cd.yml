name: Resume Site CI/CD

on:
  pull_request:
    branches:
      - main
      - beta
      - dev
      - "feature/*"
  push:
    branches:
      - main
      - beta
      - dev

permissions:
  contents: write
  id-token: write
  pull-requests: write

jobs:
  # ==========================================
  # JOB 1: VALIDATION & TESTING
  # Runs on: ALL PRs and pushes
  # Purpose: Lint, validate, test
  # ==========================================
  validate:
    name: Validate & Test
    runs-on: ubuntu-latest
    
    steps:
      # --- SETUP ---
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: Setup git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'
          cache: 'pip'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Install terraform-docs
        run: |
          echo "ðŸ“¦ Installing terraform-docs..."
          wget -q https://github.com/terraform-docs/terraform-docs/releases/download/v0.17.0/terraform-docs-v0.17.0-linux-amd64.tar.gz
          tar -xzf terraform-docs-v0.17.0-linux-amd64.tar.gz
          sudo mv terraform-docs /usr/local/bin/
          terraform-docs --version

      - name: Install tflint
        run: |
          echo "ðŸ“¦ Installing tflint..."
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
          tflint --version

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          echo "ðŸ“¦ Installing Python tools..."
          python -m pip install --upgrade pip
          pip install pre-commit black flake8 flake8-bugbear boto3 requests
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Cache pre-commit
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}

      # --- AUTO-FIX PHASE ---
      - name: Run auto-fixes
        id: auto-fix
        continue-on-error: true
        run: |
          echo "ðŸ”§ Running auto-fixes..."
          
          # Black formatting
          black --line-length 88 . || true
          
          # Remove unused imports
          find . -name "*.py" -type f ! -path "*/venv/*" ! -path "*/.venv/*" -exec sed -i '/^import os$/d' {} + 2>/dev/null || true
          
          # Terraform formatting
          terraform fmt -recursive || true
          
          # Fix trailing whitespace
          find . -type f \( -name "*.py" -o -name "*.md" -o -name "*.yml" -o -name "*.yaml" -o -name "*.tf" \) \
            ! -path "*/node_modules/*" ! -path "*/.venv/*" ! -path "*/venv/*" \
            -exec sed -i 's/[[:space:]]*$//' {} + 2>/dev/null || true
          
          # Ensure EOF newlines
          find . -type f \( -name "*.py" -o -name "*.md" -o -name "*.yml" -o -name "*.yaml" -o -name "*.tf" \) \
            ! -path "*/node_modules/*" ! -path "*/.venv/*" ! -path "*/venv/*" \
            -exec sh -c 'tail -c1 "$1" | read -r _ || echo >> "$1"' sh {} \; 2>/dev/null || true

      - name: Commit auto-fixes
        id: commit-fixes
        if: github.event_name == 'push'
        run: |
          git add -A
          if ! git diff --staged --quiet; then
            git commit -m "style: auto-fix linting issues [skip ci]" || true
            git push || echo "âš ï¸ Could not push changes"
            echo "fixes_committed=true" >> $GITHUB_OUTPUT
          else
            echo "fixes_committed=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      # --- VALIDATION PHASE ---
      - name: Install pre-commit hooks
        run: pre-commit install || true

      - name: Run pre-commit checks
        id: precommit
        continue-on-error: true
        run: pre-commit run --all-files || true

      - name: Run flake8
        id: flake8
        continue-on-error: true
        run: |
          flake8 --max-line-length=88 --extend-ignore=E203,E501,W503 \
            --exclude=.git,__pycache__,venv,.venv,build,dist \
            --per-file-ignores="__init__.py:F401" . || true

      - name: Terraform Format Check
        id: terraform-fmt
        run: |
          echo "ðŸ” Checking Terraform format..."
          terraform fmt -check -recursive
          echo "âœ… Terraform format check passed"

      - name: Terraform Init
        id: terraform-init
        run: |
          echo "ðŸ”§ Initializing Terraform..."
          cd terraform
          terraform init
          echo "âœ… Terraform initialized"

      - name: Terraform Validate
        id: terraform-validate
        run: |
          echo "ðŸ” Validating Terraform..."
          cd terraform
          terraform validate
          echo "âœ… Terraform validation passed"

      - name: Terraform Plan
        id: terraform-plan
        run: |
          echo "ðŸ“‹ Creating Terraform plan..."
          cd terraform
          terraform plan -out=tfplan
          echo "âœ… Terraform plan created"
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.sha }}
          path: terraform/tfplan
          retention-days: 5

      # --- VALIDATION SUMMARY ---
      - name: Validation Summary
        if: always()
        run: |
          echo "## ðŸ” Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Linting
          echo "### Linting" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.precommit.outcome }}" == "success" ]; then
            echo "- âœ… Pre-commit checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Pre-commit checks had warnings" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.flake8.outcome }}" == "success" ]; then
            echo "- âœ… Python linting passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Python linting had warnings" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Terraform
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform format: ${{ steps.terraform-fmt.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform init: ${{ steps.terraform-init.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform validate: ${{ steps.terraform-validate.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform plan: ${{ steps.terraform-plan.outcome }}" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tfFmt = '${{ steps.terraform-fmt.outcome }}';
            const tfValidate = '${{ steps.terraform-validate.outcome }}';
            const tfPlan = '${{ steps.terraform-plan.outcome }}';
            
            const fmtIcon = tfFmt === 'success' ? 'âœ…' : 'âŒ';
            const validateIcon = tfValidate === 'success' ? 'âœ…' : 'âŒ';
            const planIcon = tfPlan === 'success' ? 'âœ…' : 'âŒ';
            
            const output = `## ðŸ” Validation Results
            
            ### Infrastructure Checks
            ${fmtIcon} **Terraform Format:** ${tfFmt}
            ${validateIcon} **Terraform Validate:** ${tfValidate}
            ${planIcon} **Terraform Plan:** ${tfPlan}
            
            ### Code Quality
            - âœ… Linting checks completed
            - âœ… Auto-fixes applied where possible
            
            ### Next Steps
            ${tfPlan === 'success' ? 'âœ… Ready to merge! Deployment will run automatically on merge to main.' : 'âŒ Please fix validation errors before merging.'}
            
            ---
            ðŸ“¦ [Download Terraform Plan](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  # ==========================================
  # JOB 2: DEPLOY TO DEV/BETA
  # Runs on: Push to dev/beta branches
  # Purpose: Deploy to non-prod environments
  # ==========================================
  deploy-nonprod:
    name: Deploy to ${{ github.ref_name }}
    runs-on: ubuntu-latest
    needs: validate
    if: |
      github.event_name == 'push' && 
      (github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/beta')
    
    environment:
      name: ${{ github.ref_name }}
      url: https://${{ secrets.RESUME_BUCKET }}.s3.${{ secrets.AWS_REGION }}.amazonaws.com/${{ github.ref_name }}/index.html
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install boto3 requests
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Generate & Deploy Resume
        run: |
          ENV="${{ github.ref_name }}"
          echo "ðŸŽ¯ Deploying to environment: $ENV"
          
          if [ -f "scripts/generate_and_deploy.py" ]; then
            python scripts/generate_and_deploy.py --env $ENV --bucket ${{ secrets.RESUME_BUCKET }}
          elif [ -f "terraform/scripts/generate_and_deploy.py" ]; then
            python terraform/scripts/generate_and_deploy.py --env $ENV --bucket ${{ secrets.RESUME_BUCKET }}
          else
            echo "âŒ Deployment script not found"
            exit 1
          fi

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment to ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Bucket:** \`${{ secrets.RESUME_BUCKET }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://${{ secrets.RESUME_BUCKET }}.s3.${{ secrets.AWS_REGION }}.amazonaws.com/${{ github.ref_name }}/index.html" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Non-production deployment complete!" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # JOB 3: DEPLOY TO PRODUCTION
  # Runs on: Push to main branch only
  # Purpose: Deploy to production
  # ==========================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    environment:
      name: production
      url: https://${{ secrets.RESUME_BUCKET }}.s3.${{ secrets.AWS_REGION }}.amazonaws.com/index.html
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'
          cache: 'pip'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-${{ github.sha }}
          path: terraform/

      - name: Terraform Init
        run: |
          echo "ðŸ”§ Initializing Terraform..."
          cd terraform
          terraform init

      - name: Terraform Apply
        run: |
          echo "ðŸš€ Applying Terraform changes..."
          cd terraform
          terraform apply -auto-approve tfplan
          echo "âœ… Infrastructure deployed"
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Install Python dependencies
        run: |
          pip install boto3 requests
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Generate & Deploy Resume
        run: |
          echo "ðŸŽ¯ Deploying to PRODUCTION"
          
          if [ -f "scripts/generate_and_deploy.py" ]; then
            python scripts/generate_and_deploy.py --env prod --bucket ${{ secrets.RESUME_BUCKET }}
          elif [ -f "terraform/scripts/generate_and_deploy.py" ]; then
            python terraform/scripts/generate_and_deploy.py --env prod --bucket ${{ secrets.RESUME_BUCKET }}
          else
            echo "âŒ Deployment script not found"
            exit 1
          fi

      - name: Production Deployment Summary
        run: |
          echo "## ðŸŽ‰ Production Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** \`production\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Bucket:** \`${{ secrets.RESUME_BUCKET }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** \`${{ secrets.AWS_REGION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What Was Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform infrastructure applied" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AI-generated resume deployed to S3" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Production site updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Access Your Site" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Live URL:** https://${{ secrets.RESUME_BUCKET }}.s3.${{ secrets.AWS_REGION }}.amazonaws.com/index.html" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify deployment success
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commit = await github.rest.repos.getCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha
            });
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              context: 'Production Deployment',
              description: 'Successfully deployed to production',
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            });

  # ==========================================
  # JOB 4: FINAL SUMMARY
  # Runs on: Always (after all jobs)
  # Purpose: Provide overall status
  # ==========================================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [validate, deploy-nonprod, deploy-production]
    if: always()
    
    steps:
      - name: Generate Pipeline Summary
        run: |
          echo "## ðŸ“Š Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Validation Status
          echo "### Validation Stage" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.validate.result }}" == "success" ]; then
            echo "âœ… **Status:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Deployment Status
          echo "### Deployment Stage" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            if [ "${{ needs.deploy-production.result }}" == "success" ]; then
              echo "âœ… **Production:** Deployed successfully" >> $GITHUB_STEP_SUMMARY
              echo "ðŸŒ **URL:** https://${{ secrets.RESUME_BUCKET }}.s3.${{ secrets.AWS_REGION }}.amazonaws.com/index.html" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.deploy-production.result }}" == "skipped" ]; then
              echo "â­ï¸ **Production:** Skipped (validation failed)" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Production:** Deployment failed" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "${{ github.ref }}" == "refs/heads/dev" ] || [ "${{ github.ref }}" == "refs/heads/beta" ]; then
            if [ "${{ needs.deploy-nonprod.result }}" == "success" ]; then
              echo "âœ… **${{ github.ref_name }}:** Deployed successfully" >> $GITHUB_STEP_SUMMARY
              echo "ðŸŒ **URL:** https://${{ secrets.RESUME_BUCKET }}.s3.${{ secrets.AWS_REGION }}.amazonaws.com/${{ github.ref_name }}/index.html" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.deploy-nonprod.result }}" == "skipped" ]; then
              echo "â­ï¸ **${{ github.ref_name }}:** Skipped (validation failed)" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **${{ github.ref_name }}:** Deployment failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ **Deployment:** Not triggered (PR or feature branch)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY