# .github/workflows/deploy-and-validate.yml
on:
  push:
    branches:
      - dev
      - beta
      - main   # or prod
      # ... or other feature branches if needed

jobs:
  deploy-and-validate:
    runs-on: ubuntu-latest

    env:
      PIP_CACHE_DIR: ~/.cache/pip
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      S3_PREFIX: ${{ github.ref_name }}

    needs: 
      - terraform  # optional, if you make it a dependent workflow (or you rely on sequencing manually)
    steps:
      - name: checkout
        uses: actions/checkout@v3

      - name: run validations
        run: |
          cd terraform
          terraform validate
          terraform fmt -check -recursive
        # optionally include tests: `terraform plan`, `terraform show`, custom linting, OPA/Checkov, etc.

      - name: run application / script deploy
        run: |
          python scripts/generate_and_deploy.py --env ${{ github.ref }}
        # or other logic depending on env